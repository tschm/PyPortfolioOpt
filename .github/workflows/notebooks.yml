name: notebooks

on:
  pull_request:
  push:
    branches:
      - main
permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [ '3.10', '3.11', '3.12', '3.13', '3.14' ]
      fail-fast: false

    steps:
    - uses: actions/checkout@v5

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python -c "import sys; print(sys.version)"

    - name: Install dependencies
      shell: bash
      run: uv pip install ".[dev,all_extras,notebook_test]" --no-cache-dir
      env:
        UV_SYSTEM_PYTHON: 1

    - name: Show dependencies
      run: uv pip list

    # Discover all notebooks
    - name: Collect notebooks
      id: notebooks
      shell: bash
      run: |
        NOTEBOOKS=$(find cookbook -name '*.ipynb' -print0 | xargs -0 echo)
        echo "notebooks=$NOTEBOOKS" >> $GITHUB_OUTPUT

    # Run all discovered notebooks with nbmake
    - name: Test notebooks
      shell: bash
      run: |
        uv run pytest --reruns 3 --nbmake --nbmake-timeout=3600 -vv ${{ steps.notebooks.outputs.notebooks }}
